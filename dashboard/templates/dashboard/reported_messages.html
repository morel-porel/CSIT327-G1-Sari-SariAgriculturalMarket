{% extends 'dashboard/admin_layout_base.html' %}
{% load static %}

{% block title %}Reported Messages{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'dashboard/admin.css' %}">
    <link rel="stylesheet" href="{% static 'dashboard/reports.css' %}">
{% endblock %}

{% block panel_content %}

    <div class="report-header">
        <h2 class="section-title">Reported Messages</h2>
        <div class="filter-bar">
            <input type="text" placeholder="Search Reports..." id="search-reports">
            <button class="btn-filter" type="button" onclick="filterReports()">Filter</button>
        </div>
    </div>

    <form method="POST" class="report-form" id="bulk-action-form">
        {% csrf_token %}
        
        <!-- Bulk Action Bar -->
        <div style="margin-bottom: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; display: flex; align-items: center; gap: 1rem;">
            <label for="bulk-action-select" style="font-weight: 600; color: #285429;">Action:</label>
            <select name="bulk_action" id="bulk-action-select" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; flex: 1; max-width: 400px;">
                <option value="">---------</option>
                <option value="warn">Warn reported user(s) and resolve report(s)</option>
                <option value="resolve">Mark selected reports as resolved (No action needed)</option>
                <option value="delete_message">Delete (hide) message(s) and resolve related report(s)</option>
                <option value="delete_report">Delete selected Message Reports</option>
                <option value="ban">Ban reported user(s) and resolve report(s)</option>
            </select>
            <button type="submit" class="btn-filter" style="padding: 0.5rem 1.5rem; background: #285429; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: 600;">Go</button>
            <span id="selection-count" style="color: #666; font-size: 0.9rem;">0 selected</span>
        </div>
        
        <div class="table-container">
            <table class="report-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="select-all" title="Select All">
                        </th>
                        <th>ID</th>
                        <th>Reported Message</th>
                        <th>Sender</th>
                        <th>Reason</th>
                        <th>Reported By</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Moderation Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for report in reports %}
                    <tr class="{% if report.is_resolved %}is-resolved{% endif %}" data-report-id="{{ report.id }}">
                        <td>
                            <input type="checkbox" name="selected_reports" value="{{ report.id }}" class="report-checkbox">
                        </td>
                        <td>{{ report.id }}</td>
                        <td class="message-content">"{{ report.message.text_content|truncatechars:100 }}"</td>
                        <td>
                            <strong>{{ report.message.sender.username }}</strong>
                            <br>
                            <small style="color: {% if report.message.sender.is_permanently_banned %}#991b1b{% elif report.message.sender.is_suspended %}#dc3545{% elif report.message.sender.suspension_count > 0 %}#faa625{% else %}#2e7d32{% endif %};">
                                {% if report.message.sender.is_permanently_banned %}
                                    üö´ PERMANENTLY BANNED
                                {% elif report.message.sender.is_suspended %}
                                    ‚õî SUSPENDED ({{ report.message.sender.suspension_count }}/3)
                                {% elif report.message.sender.suspension_count > 0 %}
                                    ‚ö†Ô∏è Warnings: {{ report.message.sender.warning_count }}/2 | Suspensions: {{ report.message.sender.suspension_count }}/3
                                {% else %}
                                    ‚ö†Ô∏è {{ report.message.sender.warning_count }}/2
                                {% endif %}
                            </small>
                        </td>
                        <td>{{ report.reason|truncatechars:50 }}</td>
                        <td>{{ report.reporter.username }}</td>
                        <td>{{ report.reported_at|date:"M d, Y, g:i a" }}</td>
                        <td>
                            {% if report.is_resolved %}
                                <span class="status-resolved">‚úì</span>
                            {% else %}
                                <span class="status-pending">‚úó</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if report.moderation_action and report.moderation_action != 'none' %}
                                {{ report.get_moderation_action_display }}
                            {% else %}
                                No Action Taken
                            {% endif %}
                            {% if report.moderator %}
                                <br><small style="color: #666;">by {{ report.moderator.username }}</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 2rem; color: #666;">No reported messages found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    
    <div class="report-footer-buttons">
        <button type="button" class="btn-export-reports" onclick="window.location.reload()">Refresh Data</button>
        <button type="button" class="btn-export-reports" onclick="alert('CSV export feature coming soon!')">Export CSV</button>
    </div>

    <script>
        // Select All functionality
        document.getElementById('select-all').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.report-checkbox');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateSelectionCount();
        });
        
        // Update selection count
        document.querySelectorAll('.report-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectionCount);
        });
        
        function updateSelectionCount() {
            const count = document.querySelectorAll('.report-checkbox:checked').length;
            document.getElementById('selection-count').textContent = count + ' of ' + 
                document.querySelectorAll('.report-checkbox').length + ' selected';
        }
        
        // Form submission validation
        document.getElementById('bulk-action-form').addEventListener('submit', function(e) {
            const action = document.getElementById('bulk-action-select').value;
            const selectedCheckboxes = document.querySelectorAll('.report-checkbox:checked');
            
            if (!action) {
                e.preventDefault();
                alert('Please select an action from the dropdown.');
                return false;
            }
            
            if (selectedCheckboxes.length === 0) {
                e.preventDefault();
                alert('Please select at least one report to perform this action.');
                return false;
            }
            
            // Confirmation messages
            let confirmMsg = '';
            if (action === 'warn') {
                confirmMsg = `Send warnings to ${selectedCheckboxes.length} user(s) and resolve their reports? Users with 2 warnings will be SUSPENDED.`;
            } else if (action === 'delete_message') {
                confirmMsg = `Delete ${selectedCheckboxes.length} message(s) permanently? This cannot be undone.`;
            } else if (action === 'delete_report') {
                confirmMsg = `Delete ${selectedCheckboxes.length} report(s)? This cannot be undone.`;
            } else if (action === 'ban') {
                confirmMsg = `BAN ${selectedCheckboxes.length} user(s) immediately? This will suspend their accounts.`;
            } else if (action === 'resolve') {
                confirmMsg = `Mark ${selectedCheckboxes.length} report(s) as resolved without taking action?`;
            }
            
            if (confirmMsg && !confirm(confirmMsg)) {
                e.preventDefault();
                return false;
            }
        });
        
        function filterReports() {
            const searchInput = document.getElementById('search-reports').value.toLowerCase();
            const rows = document.querySelectorAll('.report-table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Allow filtering on Enter key
        document.getElementById('search-reports').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                filterReports();
            }
        });
    </script>

{% endblock %}