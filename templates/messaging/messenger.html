{% extends 'base.html' %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <link rel="stylesheet" href="{% static 'css/messenger.css' %}">
    <style>
        body { overflow: hidden; }
        .container { height: calc(100vh - 70px) !important; }
        .sidebar { width: 350px; border-right: 1px solid var(--border-color); padding: 0; background: var(--bg-primary); }
        .main { background-color: var(--bg-secondary); }
        .content { padding: 0; display: flex; flex-direction: column; height: 100%; background: transparent; }
        .search-bar { visibility: hidden !important; opacity: 0; }
    </style>
{% endblock %}

{% block content %}
<main class="container">
    
    <aside class="sidebar messenger-sidebar">
        <div class="messenger-sidebar-header">
            <h2>Messages</h2>
            <div class="search-wrapper">
                <img src="{% static 'icons/search.png' %}" class="search-icon-small">
                <input type="text" id="convo-search" placeholder="Search people..." onkeyup="filterConversations()">
            </div>
        </div>

        <div class="conversation-list" id="conversation-list">
            {% for convo, other, last_message, unread_count in conversations_with_recipient %}
                <a href="{% url 'conversation_detail' convo.id %}" class="convo-item {% if other_participant.id == other.id %}active{% endif %}">
                    <div class="convo-avatar-wrapper">
                        {% if other.avatar %}
                            <img src="{{ other.avatar.url }}" class="convo-avatar">
                        {% else %}
                            <img src="{% static 'icons/profile.png' %}" class="convo-avatar">
                        {% endif %}
                    </div>
                    
                    <div class="convo-info">
                        <div class="convo-top">
                            <span class="convo-name">{{ other.username }}</span>
                            {% if last_message %}
                                <span class="convo-time">{{ last_message.timestamp|date:"M d" }}</span>
                            {% endif %}
                        </div>
                        <div class="convo-bottom">
                            <span class="convo-preview">
                                {% if last_message %}
                                    {% if last_message.sender == request.user %}You: {% endif %}
                                    {% if last_message.is_moderator_deleted %}
                                        <i style="color:#dc3545;">Message removed</i>
                                    {% else %}
                                        {{ last_message.text_content|truncatechars:25 }}
                                    {% endif %}
                                {% else %}
                                    Start chatting...
                                {% endif %}
                            </span>
                            {% if unread_count > 0 %}
                                <span class="unread-badge">{{ unread_count }}</span>
                            {% endif %}
                        </div>
                    </div>
                </a>
            {% empty %}
                <div class="empty-convo-state">
                    <p>No conversations yet.</p>
                </div>
            {% endfor %}
        </div>
    </aside>

    <div class="main">
        <section class="content">
            {% if other_participant %}
                
                <div class="chat-header">
                    <div class="chat-header-user">
                        {% if other_participant.avatar %}
                            <img src="{{ other_participant.avatar.url }}" class="header-avatar">
                        {% else %}
                            <img src="{% static 'icons/profile.png' %}" class="header-avatar">
                        {% endif %}
                        <div class="header-details">
                            <h3>{{ other_participant.username }}</h3>
                            {% if other_participant.role == 'VENDOR' and other_participant.vendorprofile.shop_name %}
                                <span class="header-badge">Shop: {{ other_participant.vendorprofile.shop_name }}</span>
                            {% else %}
                                <span class="header-status">Active now</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="header-actions">
                    </div>
                </div>

                <div class="chat-messages-area" id="chat-window">
                    {% for message in chat_messages %}
                        <div class="message-wrapper {% if message.sender == request.user %}outgoing{% else %}incoming{% endif %}">
                            
                            {% if message.sender != request.user %}
                                <div class="message-avatar-spacer">
                                    {% if message.sender.avatar %}
                                        <img src="{{ message.sender.avatar.url }}" class="tiny-avatar">
                                    {% else %}
                                        <img src="{% static 'icons/profile.png' %}" class="tiny-avatar">
                                    {% endif %}
                                </div>
                            {% endif %}

                            <div class="message-bubble">
                                {% if message.is_moderator_deleted %}
                                    <span class="deleted-msg">This message was removed by moderation.</span>
                                {% else %}
                                    {% if message.text_content %}
                                        <p>{{ message.text_content|linebreaksbr }}</p>
                                    {% endif %}
                                    
                                    {% if message.media_file %}
                                        <div class="message-media">
                                            {% with f_url=message.media_file.url|lower %}
                                                {% if '.jpg' in f_url or '.png' in f_url or '.jpeg' in f_url %}
                                                    <a href="{{ message.media_file.url }}" target="_blank">
                                                        <img src="{{ message.media_file.url }}" class="img-preview">
                                                    </a>
                                                {% else %}
                                                    <a href="{{ message.media_file.url }}" target="_blank" class="file-link">
                                                        ðŸ“„ View Attachment
                                                    </a>
                                                {% endif %}
                                            {% endwith %}
                                        </div>
                                    {% endif %}
                                {% endif %}
                                <span class="message-time">{{ message.timestamp|date:"g:i A" }}</span>
                            </div>

                            {% if message.sender != request.user and not message.is_moderator_deleted %}
                                <button type="button" class="report-btn" onclick="openReportModal('{{ message.id }}')" title="Report">!</button>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <div class="chat-input-area">
                    <div id="file-preview-bar" class="file-preview-bar" style="display:none;">
                        <span id="file-name"></span>
                        <button type="button" onclick="removeFile()">Ã—</button>
                    </div>
                    
                    <form method="post" enctype="multipart/form-data" class="input-form">
                        {% csrf_token %}
                        
                        <label for="media_file" class="attach-btn" title="Attach File">
                            <span>ðŸ“Ž</span>
                        </label>
                        <input type="file" name="media_file" id="media_file" style="display:none;" onchange="handleFileSelect(this)">
                        
                        <textarea name="text_content" class="msg-input" placeholder="Type a message..." rows="1" oninput="autoResize(this)"></textarea>
                        
                        <button type="submit" class="send-btn">
                            Send
                        </button>
                    </form>
                </div>

            {% else %}
                <div class="empty-chat-view">
                    <img src="{% static 'icons/sari-sari-logo.png' %}" class="empty-logo">
                    <h2>Select a conversation</h2>
                    <p>Choose a user from the sidebar to start chatting</p>
                </div>
            {% endif %}
        </section>
    </div>
</main>

<div id="reportModal" class="modal" style="display:none; align-items:center; justify-content:center;">
    <div class="modal-content" style="max-width:400px; height:auto; flex-direction:column; padding:20px;">
        <h3 style="color:#d32f2f;">Report Message</h3>
        <p>Why are you reporting this?</p>
        <textarea id="reportReason" style="width:100%; border:1px solid #ddd; padding:10px; margin:10px 0; border-radius:4px;" rows="3"></textarea>
        <input type="hidden" id="msgIdToReport">
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button onclick="closeReportModal()" style="background:#eee; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Cancel</button>
            <button onclick="submitReport()" style="background:#d32f2f; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Submit</button>
        </div>
    </div>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    if(chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    function handleFileSelect(input) {
        const bar = document.getElementById('file-preview-bar');
        if(input.files && input.files[0]) {
            document.getElementById('file-name').textContent = input.files[0].name;
            bar.style.display = 'flex';
        }
    }
    function removeFile() {
        document.getElementById('media_file').value = '';
        document.getElementById('file-preview-bar').style.display = 'none';
    }

    function filterConversations() {
        const input = document.getElementById('convo-search').value.toLowerCase();
        const items = document.querySelectorAll('.convo-item');
        items.forEach(item => {
            const name = item.querySelector('.convo-name').textContent.toLowerCase();
            item.style.display = name.includes(input) ? 'flex' : 'none';
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function openReportModal(id) {
        document.getElementById('msgIdToReport').value = id;
        document.getElementById('reportModal').style.display = 'flex';
    }
    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
    }
    function submitReport() {
        const id = document.getElementById('msgIdToReport').value;
        const reason = document.getElementById('reportReason').value;
        if(!reason) return alert("Please provide a reason");

        fetch(`/messages/report/${id}/`, {
            method: 'POST',
            headers: {'X-CSRFToken': getCookie('csrftoken'), 'Content-Type': 'application/x-www-form-urlencoded'},
            body: `reason=${encodeURIComponent(reason)}`
        }).then(res => res.json()).then(data => {
            alert(data.message);
            closeReportModal();
        });
    }
</script>
{% endblock %}