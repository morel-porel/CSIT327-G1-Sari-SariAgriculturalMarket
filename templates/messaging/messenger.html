{% extends 'base.html' %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/messenger.css' %}">
{% endblock %}


{% block content %}

<div class="my-centered-rectangle">

    <div class="chat-left-panel" id="chat-left-panel">
        
        <div class="chat-panel-header">
            <h2>Messages</h2>
            <div class="chat-search-container">
                <img src="{% static 'icons/search.png' %}" alt="Search" class="chat-search-icon">
                <input type="text" class="chat-search-input" placeholder="Search conversations...">
            </div>
        </div>
        
        <div class="conversation-list">
            {% for convo, other, last_message, unread_count in conversations_with_recipient %}
                <a href="{% url 'conversation_detail' convo.id %}" class="conversation-item {% if other_participant.id == other.id %}active{% endif %}">
                    <div class="convo-avatar">
                        {% if other.avatar %}
                            <img src="{{ other.avatar.url }}" alt="{{ other.username }}'s avatar">
                        {% else %}
                            <img src="{% static 'icons/profile.png' %}" alt="Default avatar">
                        {% endif %}
                    </div>
                    <div class="convo-details">
                        <span class="convo-user">{{ other.username }}</span>
                        <span class="convo-excerpt">
                            {% if last_message %}
                                {% if last_message.sender == request.user %}You: {% endif %}
                                {{ last_message.text_content|truncatechars:30 }}
                            {% else %}
                                Start the conversation
                            {% endif %}
                        </span>
                    </div>
                    <div class="convo-meta">
                        {% if last_message %}
                            <span class="convo-timestamp">{{ last_message.timestamp|timesince }} ago</span>
                        {% endif %}
                        {% if unread_count > 0 %}
                            <span class="convo-unread-count">{{ unread_count }}</span>
                        {% endif %}
                    </div>
                </a>
            {% empty %}
                <p class="chat-list-empty">You have no messages.</p>
            {% endfor %}
        </div>
    </div>

    <div class="chat-divider" id="chat-divider"></div>

    <div class="chat-right-panel">
        
        {% if other_participant %}
            <div class="chat-header">
                <div class="chat-avatar">
                    {% if other_participant.avatar %}
                        <img src="{{ other_participant.avatar.url }}" alt="{{ other_participant.username }}'s avatar">
                    {% else %}
                        <img src="{% static 'icons/profile.png' %}" alt="Default avatar">
                    {% endif %}
                </div>
                <div class="chat-info">
                    <h2>{{ other_participant.username }}</h2>
                    {% if other_participant.vendorprofile.shop_name %}
                        <span class="shop-name">{{ other_participant.vendorprofile.shop_name }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="chat-window" id="chat-window">
                {% for message in chat_messages %}  <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                        <div class="message-bubble">
                            <p>{{ message.text_content }}</p>

                            {% if message.media_file %}
                                <div class="message-media">
                                    {% if 'jpg' in message.media_file.url or 'png' in message.media_file.url or 'jpeg' in message.media_file.url %}
                                        <a href="{{ message.media_file.url }}" target="_blank">
                                            <img src="{{ message.media_file.url }}" alt="Attached media">
                                        </a>
                                    {% else %}
                                        <a href="{{ message.media_file.url }}" target="_blank" class="file-attachment">
                                            <img src="{% static 'icons/search.png' %}" alt="File" style="width: 16px; margin-right: 8px;">
                                            View Attached File
                                        </a>
                                    {% endif %}
                                </div>
                            {% endif %}
                            
                            <span class="message-timestamp">
                                {{ message.timestamp|date:"P M d" }}
                                {% if message.sender == request.user and message.is_read %}
                                    <span class="read-receipt">(Read)</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <form class="message-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <label for="media_file_input" class="file-label">
                    <img src="{% static 'icons/search.png' %}" alt="Attach File" style="width:20px; height:20px; opacity: 0.6;">
                </label>
                <input type="file" name="media_file" id="media_file_input" style="display: none;">
                
                <textarea name="text_content" placeholder="Type your message..." rows="1" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';" autocomplete="off"></textarea>
                
                <button type="submit" class="btn-send">
                    <img src="{% static 'icons/search.png' %}" alt="Send" style="width:20px; height:20px;">
                </button>
            </form>

        {% else %}
            <div class="chat-placeholder">
                <img src="{% static 'icons/sari-sari-logo.png' %}" alt="Logo" width="100">
                <h2>Select a conversation</h2>
                <p>Choose from your existing conversations on the left to start chatting.</p>
            </div>
        {% endif %}
    </div>

</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- SCROLL TO BOTTOM ---
        // This finds the chat window and scrolls it to the latest message
        const chatWindow = document.getElementById('chat-window');
        if (chatWindow) {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- DIVIDER LOGIC ---
        const divider = document.getElementById('chat-divider');
        const leftPanel = document.getElementById('chat-left-panel');
        
        if (!divider) return; // Exit if divider doesn't exist

        let isResizing = false;

        divider.addEventListener('mousedown', function(e) {
            isResizing = true;
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', stopResize);
        });

        function handleMouseMove(e) {
            if (!isResizing) return;
            const containerRect = leftPanel.parentElement.getBoundingClientRect();
            let newLeftWidth = e.clientX - containerRect.left;

            // Enforce min/max widths
            if (newLeftWidth < 250) newLeftWidth = 250;
            if (newLeftWidth > (containerRect.width - 250)) newLeftWidth = (containerRect.width - 250);
            
            leftPanel.style.width = newLeftWidth + 'px';
            leftPanel.style.flexBasis = newLeftWidth + 'px';
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', stopResize);
        }
    });
</script>

{% endblock %}