{% extends 'base.html' %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/messenger.css' %}">
{% endblock %}


{% block content %}

<div class="my-centered-rectangle">

    <div class="chat-left-panel" id="chat-left-panel">
        
        <div class="chat-panel-header">
            <h2>Messages</h2>
            <div class="chat-search-container">
                <img src="{% static 'icons/search.png' %}" alt="Search" class="chat-search-icon">
                <input type="text" class="chat-search-input" placeholder="Search conversations...">
            </div>
        </div>
        
        <div class="conversation-list">
            {% for convo, other, last_message, unread_count in conversations_with_recipient %}
                <a href="{% url 'conversation_detail' convo.id %}" class="conversation-item {% if other_participant.id == other.id %}active{% endif %}">
                    <div class="convo-avatar">
                        {% if other.avatar %}
                            <img src="{{ other.avatar.url }}" alt="{{ other.username }}'s avatar">
                        {% else %}
                            <img src="{% static 'icons/profile.png' %}" alt="Default avatar">
                        {% endif %}
                    </div>
                    <div class="convo-details">
                        <span class="convo-user">{{ other.username }}</span>
                        <span class="convo-excerpt">
                            {% if last_message %}
                                {% if last_message.sender == request.user %}You: {% endif %}
                                {% if last_message.is_moderator_deleted %}
                                    <span style="color: red;">[Message Removed]</span>
                                {% else %}
                                    {{ last_message.text_content|truncatechars:30 }}
                                {% endif %}
                            {% else %}
                                Start the conversation
                            {% endif %}
                        </span>
                    </div>
                    <div class="convo-meta">
                        {% if last_message %}
                            <span class="convo-timestamp">{{ last_message.timestamp|timesince }} ago</span>
                        {% endif %}
                        {% if unread_count > 0 %}
                            <span class="convo-unread-count">{{ unread_count }}</span>
                        {% endif %}
                    </div>
                </a>
            {% empty %}
                <p class="chat-list-empty">You have no messages.</p>
            {% endfor %}
        </div>
    </div>

    <div class="chat-divider" id="chat-divider"></div>

    <div class="chat-right-panel">
        
        {% if other_participant %}
            <div class="chat-header">
                <div class="chat-avatar">
                    {% if other_participant.avatar %}
                        <img src="{{ other_participant.avatar.url }}" alt="{{ other_participant.username }}'s avatar">
                    {% else %}
                        <img src="{% static 'icons/profile.png' %}" alt="Default avatar">
                    {% endif %}
                </div>
                <div class="chat-info">
                    <h2>{{ other_participant.username }}</h2>
                    {% if other_participant.vendorprofile.shop_name %}
                        <span class="shop-name">{{ other_participant.vendorprofile.shop_name }}</span>
                    {% endif %}
                </div>
            </div>

            <div class="chat-window" id="chat-window">
                {% for message in chat_messages %}
                    <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                        <div class="message-bubble">
                            
                            {% if message.is_moderator_deleted %}
                                <p style="color: red; font-style: italic;">This message has been removed by a moderator.</p>
                            {% else %}
                                <p>{{ message.text_content }}</p>

                                {% if message.media_file %}
                                    <div class="message-media">
                                        {% with message_url_lower=message.media_file.url|lower %}
                                            {% if '.jpg' in message_url_lower or '.png' in message_url_lower or '.jpeg' in message_url_lower or '.gif' in message_url_lower %}
                                                <a href="{{ message.media_file.url }}" target="_blank">
                                                    <img src="{{ message.media_file.url }}" alt="Attached media">
                                                </a>
                                            {% else %}
                                                <a href="{{ message.media_file.url }}" target="_blank" class="file-attachment">
                                                    <img src="{% static 'icons/search.png' %}" alt="File" style="width: 16px; margin-right: 8px;">
                                                    View Attached File
                                                </a>
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                {% endif %}
                                
                                <span class="message-timestamp">
                                    {{ message.timestamp|date:"P M d" }}
                                    {% if message.sender == request.user and message.is_read %}
                                        <span class="read-receipt">(Read)</span>
                                    {% endif %}
                                </span>
                            {% endif %}
                        </div>

                        {% if message.sender != request.user and not message.is_moderator_deleted %}
                            <div class="report-btn-container">
                                <span class="report-btn-icon"
                                      onclick="openReportModal('{{ message.id }}')"
                                      style="font-size: 1.2rem; 
                                             color: #D9534F; 
                                             font-weight: 900; 
                                             line-height: 16px; 
                                             text-align: center;
                                             width: 16px;
                                             height: 16px;
                                             display: block;">
                                    !
                                </span>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>

            <div id="file-preview-container" 
                 style="display: none; 
                        padding: 10px 20px; 
                        background-color: #f0f0f0; 
                        border-top: 1px solid #e0e0e0;
                        font-size: 0.9em; 
                        color: #333;">
            </div>
            <form class="message-form" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <label for="media_file_input" class="file-label">
                    <span style="font-size: 26px; 
                                 color: #175e52; 
                                 font-weight: 300; 
                                 line-height: 20px; 
                                 opacity: 0.8;
                                 padding-bottom: 4px;">
                        +
                    </span>
                </label>
                
                <input type="file" 
                       name="media_file" 
                       id="media_file_input" 
                       style="display: none;" 
                       onchange="updateFilePreview()">
                
                <textarea name="text_content" placeholder="Type your message..." rows="1" oninput="this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px';" autocomplete="off"></textarea>
                
                <button type="submit" class="btn-send">
                    <span style="font-size: 20px; 
                                 line-height: 20px; 
                                 color: white; 
                                 margin-left: 2px; 
                                 margin-bottom: 2px;
                                 transform: rotate(45deg);
                                 display: inline-block;">
                        &#10148;
                    </span>
                </button>
            </form>

        {% else %}
            <div class="chat-placeholder">
                <img src="{% static 'icons/sari-sari-logo.png' %}" alt="Logo" width="100">
                <h2>Select a conversation</h2>
                <p>Choose from your existing conversations on the left to start chatting.</p>
            </div>
        {% endif %}
    </div>

</div>

<div id="reportModal" class="report-modal" onclick="closeReportModalOutside(event)">
    <div class="report-modal-content">
        <h3>Report Message</h3>
        <p>Please briefly explain why you are reporting this message:</p>
        <textarea id="reportReason" placeholder="e.g., Hate speech, spam, harassment, etc." maxlength="500"></textarea>
        <input type="hidden" id="messageIdToReport">
        <div class="report-actions">
            <button class="btn btn-secondary" onclick="closeReportModal()">Cancel</button>
            <button class="btn btn-danger" onclick="submitReport()">Submit Report</button>
        </div>
        <p id="reportFeedback" style="color: green; margin-top: 10px;"></p>
    </div>
</div>

<script>
    // Helper function to get the CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- Report Modal Functions ---
    function openReportModal(messageId) {
        document.getElementById('messageIdToReport').value = messageId;
        document.getElementById('reportModal').style.display = 'flex';
        document.getElementById('reportReason').value = ''; // Clear previous reason
        document.getElementById('reportFeedback').textContent = ''; // Clear feedback
    }

    function closeReportModal() {
        document.getElementById('reportModal').style.display = 'none';
    }

    function closeReportModalOutside(event) {
        if (event.target.id === 'reportModal') {
            closeReportModal();
        }
    }

    function submitReport() {
        const messageId = document.getElementById('messageIdToReport').value;
        const reason = document.getElementById('reportReason').value.trim();
        const feedbackElement = document.getElementById('reportFeedback');

        if (reason.length < 5) {
            feedbackElement.style.color = 'red';
            feedbackElement.textContent = 'Please provide a brief reason (at least 5 characters).';
            return;
        }

        feedbackElement.style.color = 'gray';
        feedbackElement.textContent = 'Submitting...';

        const url = "{% url 'report_message' message_id=123456 %}".replace('123456', messageId);
        
        const csrfToken = getCookie('csrftoken');
        
        const formData = new FormData();
        formData.append('reason', reason);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => {
            if (!response.ok && response.headers.get('content-type')?.includes('application/json')) {
                return response.json(); 
            } else if (!response.ok) {
                throw new Error('Server returned an error.');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success' || data.status === 'exists') {
                feedbackElement.style.color = 'green';
                feedbackElement.textContent = data.message;
                setTimeout(closeReportModal, 2000); 
            } else {
                feedbackElement.style.color = 'red';
                feedbackElement.textContent = data.message || 'An unknown error occurred during submission.';
            }
        })
        .catch(error => {
            console.error('Error reporting message:', error);
            feedbackElement.style.color = 'red';
            feedbackElement.textContent = 'Failed to submit report. Please try again.';
        });
    }

    // --- File Preview Functions ---
    function updateFilePreview() {
        const fileInput = document.getElementById('media_file_input');
        const previewContainer = document.getElementById('file-preview-container');

        if (fileInput.files && fileInput.files.length > 0) {
            const filename = fileInput.files[0].name;
            // Display the file name and a 'remove' button
            previewContainer.innerHTML = 'Attached: <strong>' + filename + '</strong>' +
                ' <span onclick="removeFile()" style="cursor: pointer; color: #D9534F; font-weight: bold; margin-left: 10px; float: right;">Remove</span>';
            previewContainer.style.display = 'block';
        } else {
            previewContainer.innerHTML = '';
            previewContainer.style.display = 'none';
        }
    }

    function removeFile() {
        const fileInput = document.getElementById('media_file_input');
        fileInput.value = ''; // This clears the selected file
        
        const previewContainer = document.getElementById('file-preview-container');
        previewContainer.innerHTML = '';
        previewContainer.style.display = 'none';
    }

    // --- Existing DOM Content Loaded Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        // --- SCROLL TO BOTTOM ---
        const chatWindow = document.getElementById('chat-window');
        if (chatWindow) {
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- DIVIDER LOGIC ---
        const divider = document.getElementById('chat-divider');
        const leftPanel = document.getElementById('chat-left-panel');
        
        if (!divider) return; // Exit if divider doesn't exist

        let isResizing = false;

        divider.addEventListener('mousedown', function(e) {
            isResizing = true;
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', stopResize);
        });

        function handleMouseMove(e) {
            if (!isResizing) return;
            const containerRect = leftPanel.parentElement.getBoundingClientRect();
            let newLeftWidth = e.clientX - containerRect.left;

            // Enforce min/max widths
            if (newLeftWidth < 250) newLeftWidth = 250; 
            if (newLeftWidth > (containerRect.width - 250)) newLeftWidth = (containerRect.width - 250); 
            
            leftPanel.style.width = newLeftWidth + 'px';
            leftPanel.style.flexBasis = newLeftWidth + 'px';
        }

        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', stopResize);
        }
    });
</script>

{% endblock %}