{% extends 'base.html' %}
{% load static %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/search.css' %}">
<link rel="stylesheet" href="{% static 'css/modern_modal.css' %}">
<link rel="stylesheet" href="{% static 'css/cart.css' %}">

<main class="container">
    <aside class="sidebar">
        
        <div class="filter-box">
            <h3 class="filter-title">Type</h3>
            <div class="filter-options">
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="category" value="Fresh Produce">
                    <span>Fresh Produce</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="category" value="Grains and Staples">
                    <span>Grains & Staples</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="category" value="Meat, Poultry and Seafood">
                    <span>Meat, Poultry & Seafood</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="category" value="Dairy & Eggs">
                    <span>Dairy & Eggs</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="category" value="Packaged Goods">
                    <span>Packaged Goods</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="category" value="Local & Specialty Products">
                    <span>Local & Specialty</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="category" value="Services">
                    <span>Services</span>
                </label>
            </div>
        </div>

        <div class="filter-box">
            <h3 class="filter-title">Price Range</h3>
            <div class="price-inputs">
                <input type="number" id="min-price" placeholder="₱ MIN">
                <span>-</span>
                <input type="number" id="max-price" placeholder="₱ MAX">
            </div>
            <button id="apply-price-btn" class="btn-apply">APPLY</button>
        </div>

        <div class="filter-box">
            <h3 class="filter-title">Barangay (Cebu City)</h3>
            <div class="filter-options">
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Apas">
                    <span>Apas</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Capitol Site">
                    <span>Capitol Site</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Lahug">
                    <span>Lahug</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Mabolo">
                    <span>Mabolo</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Talamban">
                    <span>Talamban</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Guadalupe">
                    <span>Guadalupe</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Banilad">
                    <span>Banilad</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Tisa">
                    <span>Tisa</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Labangon">
                    <span>Labangon</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Pardo">
                    <span>Pardo</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Basak San Nicolas">
                    <span>Basak San Nicolas</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Kamputhaw">
                    <span>Kamputhaw</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Zapatera">
                    <span>Zapatera</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Punta Princesa">
                    <span>Punta Princesa</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Sambag I">
                    <span>Sambag I</span>
                </label>
                <label class="filter-btn-label">
                    <input type="checkbox" class="filter-checkbox" name="region" value="Sambag II">
                    <span>Sambag II</span>
                </label>
            </div>
        </div>

    </aside>

    <div class="main">
        <section class="content">
            
            <div class="results-header">
                <h2 id="results-title">
                    {% if query %}
                        Search results for "{{ query }}"
                    {% else %}
                        Search Products
                    {% endif %}
                </h2>
            </div>

            <div class="grid" id="search-grid-container">
                {% if results %}
                    {% for product in results %}
                        <div class="grid-item" data-product-id="{{ product.id }}">
                            
                            {% if product.image %}
                                <div class="product-image" style="background-image: url('{{ product.image.url }}'); background-size: cover;"></div>
                            {% else %}
                                <div class="product-image"></div>
                            {% endif %}

                            <div class="product-info">
                                <h3 class="product-name">{{ product.name }}</h3>
                                <p class="product-price">₱{{ product.price }}</p>

                                {% if product.vendor.vendorprofile %}
                                    <p class="product-vendor">
                                        Seller: 
                                        <span class="vendor-name-container">
                                            {{ product.vendor.vendorprofile.shop_name }}
                                            {% if product.vendor.vendorprofile.is_verified %}
                                                <img src="{% static 'icons/verified.png' %}" class="vendor-badge" alt="Verified" title="Verified Vendor">
                                            {% endif %}
                                        </span>
                                    </p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div style="grid-column: 1 / -1; text-align:center; padding: 60px; color: var(--text-primary); background: var(--bg-primary); border-radius: 8px;">
                        <p>No results found for your criteria.</p>
                    </div>
                {% endif %}
            </div>

        </section>
    </div>
</main>

<div class="modal-backdrop" id="product-modal-backdrop" style="display: none;"></div>
<div class="modal" id="product-modal" style="display: none;">
    <button class="modal-close" id="modal-close-btn">&times;</button>
    
    <div class="modal-content">
        <div class="modal-image">
            <img src="" alt="Product Image" id="modal-img">
        </div>

        <div class="modal-details">
            <span class="modal-category-badge" id="modal-category"></span>
            
            <h2 id="modal-name">Product Name</h2>
            <p class="modal-vendor">
                Sold by <a href="#" id="modal-shop-link">Vendor Name</a>
            </p>
            
            <div class="modal-price" id="modal-price">₱0.00</div>
            
            <div class="stock-indicator">
                In Stock: <strong id="modal-stock">0</strong>
            </div>

            <p class="modal-description" id="modal-description">
                Product description goes here...
            </p>

            <div class="modal-actions">
                <a href="#" class="action-btn chat" id="modal-chat-btn" data-tooltip="Chat with Vendor">
                    <svg viewBox="0 0 24 24">
                        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
                        <path d="M7 9h10v2H7zm0-3h10v2H7z"/> 
                    </svg>
                </a>

                <button class="action-btn cart" id="modal-cart-btn" data-tooltip="Add to Cart" onclick="addToCart()">
                    <svg viewBox="0 0 24 24">
                        <path d="M11 9h2V6h3V4h-3V1h-2v3H8v2h3v3zm-4 9c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-8.9-5h7.45c.75 0 1.41-.41 1.75-1.03l3.86-7.01L19.42 4l-3.87 7H8.53L4.27 2H1v2h2l3.6 7.59-1.35 2.44C4.52 15.37 5.48 17 7 17h12v-2H7l1.1-2z"/>
                    </svg>
                </button>

                <div style="position: relative;">
                    <button class="action-btn share" id="modal-share-btn" data-tooltip="Share">
                        <svg viewBox="0 0 24 24">
                            <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                        </svg>
                    </button>
                    <div id="share-panel" class="share-popover">
                        <div id="qrcode-container" style="display: flex; justify-content: center;"></div>
                        <button onclick="copyProductLink()">Copy Link</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="vendor-modal-backdrop" style="display: none;"></div>
<div class="modal vendor-modal" id="vendor-modal" style="display: none;">
    <button class="modal-close" id="vendor-modal-close-btn">&times;</button>
    <div class="modal-content portrait-content" style="display:block; padding: 20px; height:auto;">
        <h2 id="vendor-shop-name" class="modal-title" style="margin-top:0;"></h2>
        <div class="vendor-header-image">
            <img src="" alt="Shop Profile" id="vendor-profile-img" class="vendor-profile-img">
            <span class="verification-status" id="vendor-verified"></span>
        </div>
        <div class="vendor-details-section">
            <h3>Shop Description</h3><p id="vendor-description"></p>
            <h3>Farming & Business Practices</h3><p id="vendor-practices"></p>
            <div class="meta-grid">
                <span>Experience: <strong id="vendor-experience"></strong> years</span>
                <span>Permit No: <strong id="vendor-permit-number"></strong></span>
                <span>Contact: <strong id="vendor-contact"></strong></span>
            </div>
            <hr>
            <p class="small-text">Seller Email: <span id="vendor-email"></span></p>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const checkboxes = document.querySelectorAll('.filter-checkbox');
        const priceBtn = document.getElementById('apply-price-btn');
        const productGrid = document.getElementById('search-grid-container');
        
        const urlParams = new URLSearchParams(window.location.search);
        let currentQuery = urlParams.get('q') || '';

        // --- CHECK FOR PRODUCT ID IN URL ---
        const productId = urlParams.get('product_id');
        if (productId) {
            // Wait for loadProductDetails to be defined, then load the product
            setTimeout(() => {
                if (typeof loadProductDetails === 'function') {
                    loadProductDetails(productId);
                }
            }, 100);
        }

        function applyFilters() {
            const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked'))
                                            .map(cb => cb.value).join('|'); // Use pipe delimiter since category names contain commas
            const selectedRegions = Array.from(document.querySelectorAll('input[name="region"]:checked'))
                                         .map(cb => cb.value).join(',');
            const minPrice = document.getElementById('min-price').value;
            const maxPrice = document.getElementById('max-price').value;

            let apiUrl = `/my-products/api/list/?q=${encodeURIComponent(currentQuery)}`;
            if (selectedCategories) apiUrl += `&categories=${encodeURIComponent(selectedCategories)}`;
            if (selectedRegions) apiUrl += `&regions=${encodeURIComponent(selectedRegions)}`;
            if (minPrice) apiUrl += `&min_price=${minPrice}`;
            if (maxPrice) apiUrl += `&max_price=${maxPrice}`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    productGrid.innerHTML = ''; 

                    if (data.products.length > 0) {
                        data.products.forEach(product => {
                            const productCard = document.createElement('div');
                            productCard.className = 'grid-item';
                            productCard.setAttribute('data-product-id', product.id);
                            
                            productCard.addEventListener('click', (e) => {
                                if (e.target.closest('a') || e.target.closest('button')) return;
                                loadProductDetails(product.id);
                            });

                            const verifiedBadge = product.is_verified 
                                ? `<img src="{% static 'icons/verified.png' %}" class="vendor-badge" alt="Verified" title="Verified Vendor">` 
                                : '';

                            productCard.innerHTML = `
                                <div class="product-image" style="background-image: url('${product.image_url}'); background-size: cover;"></div>
                                <div class="product-info">
                                    <h3 class="product-name">${product.name}</h3>
                                    <p class="product-price">${product.price}</p>
                                    <p class="product-vendor">
                                        Seller: 
                                        <span class="vendor-name-container">
                                            ${product.shop_name}
                                            ${verifiedBadge}
                                        </span>
                                    </p>
                                </div>
                            `;
                            productGrid.appendChild(productCard);
                        });
                    } else {
                        productGrid.innerHTML = `
                            <div style="grid-column: 1 / -1; text-align:center; padding: 60px; color: var(--text-primary); background: var(--bg-primary); border-radius: 8px;">
                                <p>No results found for the selected filters.</p>
                            </div>`;
                    }
                })
                .catch(err => console.error("Error filtering products:", err));
        }

        checkboxes.forEach(box => {
            box.addEventListener('change', applyFilters);
        });

        if(priceBtn) {
            priceBtn.addEventListener('click', applyFilters);
        }

        const productModal = document.getElementById('product-modal');
        const productBackdrop = document.getElementById('product-modal-backdrop');
        const productCloseBtn = document.getElementById('modal-close-btn');
        const vendorModal = document.getElementById('vendor-modal');
        const vendorBackdrop = document.getElementById('vendor-modal-backdrop');
        const vendorCloseBtn = document.getElementById('vendor-modal-close-btn');
        const shareBtn = document.getElementById('modal-share-btn');
        const sharePanel = document.getElementById('share-panel');
        const qrContainer = document.getElementById('qrcode-container');
        const shopLink = document.getElementById('modal-shop-link');
        
        let currentProductId = null;
        let currentProductName = "";

        const openProductModal = () => { 
            productModal.style.display = 'block'; 
            productBackdrop.style.display = 'block'; 
            sharePanel.style.display = 'none';
        };
        const closeProductModal = () => { 
            productModal.style.display = 'none'; 
            productBackdrop.style.display = 'none'; 
            sharePanel.style.display = 'none';
        };
        const openVendorModal = () => { closeProductModal(); vendorModal.style.display = 'block'; vendorBackdrop.style.display = 'block'; };
        const closeVendorModal = () => { vendorModal.style.display = 'none'; vendorBackdrop.style.display = 'none'; };

        productCloseBtn.addEventListener('click', closeProductModal);
        productBackdrop.addEventListener('click', closeProductModal);
        vendorCloseBtn.addEventListener('click', closeVendorModal);
        vendorBackdrop.addEventListener('click', closeVendorModal);

        shareBtn.addEventListener('click', () => {
            if (sharePanel.style.display === 'none' || sharePanel.style.display === '') {
                sharePanel.style.display = 'flex';
                qrContainer.innerHTML = ''; 
                const productUrl = window.location.origin + '/?product_id=' + currentProductId;
                new QRCode(qrContainer, { text: productUrl, width: 100, height: 100 });
            } else {
                sharePanel.style.display = 'none';
            }
        });

        window.shareToSocial = (platform) => {
            const url = encodeURIComponent(window.location.origin + '/?product_id=' + currentProductId);
            const text = encodeURIComponent(`Check out ${currentProductName} on Sari-Sari!`);
            let shareUrl = '';
            if (platform === 'facebook') shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            else if (platform === 'twitter') shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${text}`;
            window.open(shareUrl, '_blank', 'width=600,height=400');
        };

        window.copyProductLink = () => {
            const url = window.location.origin + '/search/?product_id=' + currentProductId;
            navigator.clipboard.writeText(url).then(() => {
                const shareBtn = document.getElementById('modal-share-btn');
                const originalTooltip = shareBtn.getAttribute('data-tooltip');
                shareBtn.setAttribute('data-tooltip', 'Copied!');
                setTimeout(() => shareBtn.setAttribute('data-tooltip', originalTooltip), 2000);
            });
        };

        window.addToCart = () => {
            const cartBtn = document.getElementById('modal-cart-btn');
            const originalHTML = cartBtn.innerHTML;
            
            cartBtn.innerHTML = '<svg viewBox="0 0 24 24"><path fill="green" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
            cartBtn.setAttribute('data-tooltip', 'Added!');
            
            const productData = {
                id: currentProductId,
                name: currentProductName,
                price: document.getElementById('modal-price').textContent,
                image: document.getElementById('modal-img').src,
                shop: document.getElementById('modal-shop-link').textContent
            };

            if (window.addToCartGlobal) {
                window.addToCartGlobal(productData);
            }
            
            setTimeout(() => {
                cartBtn.innerHTML = originalHTML;
                cartBtn.setAttribute('data-tooltip', 'Add to Cart');
            }, 2000);
        };

        const loadProductDetails = (id) => {
            openProductModal();
            fetch(`/my-products/api/${id}/`) 
                .then(response => response.json())
                .then(data => {
                    if (data.error) return; 
                    currentProductId = data.id; 
                    currentProductName = data.name;
                    
                    document.getElementById('modal-img').src = data.image_url || "{% static 'icons/placeholder.png' %}";
                    document.getElementById('modal-name').textContent = data.name;
                    document.getElementById('modal-price').textContent = data.price; 
                    document.getElementById('modal-description').textContent = data.description;
                    document.getElementById('modal-category').textContent = data.category || 'N/A';
                    document.getElementById('modal-stock').textContent = data.stock || 'N/A';
                    
                    const shopLink = document.getElementById('modal-shop-link');
                    shopLink.textContent = data.shop_name;

                    const chatBtn = document.getElementById('modal-chat-btn');
                    chatBtn.setAttribute('data-tooltip', `Chat with ${data.shop_name}`);
                    chatBtn.href = `/messages/start/${data.vendor_user_id}/`; 
                });
        };

        document.querySelectorAll('.grid-item').forEach(card => {
            card.addEventListener('click', (e) => {
                if (e.target.closest('a') || e.target.closest('button')) return;
                loadProductDetails(card.dataset.productId);
            });
        });

        if(shopLink){
            shopLink.addEventListener('click', function(e) {
                e.preventDefault(); 
                if (!currentVendorId) return;
                openVendorModal();
                fetch(`/auth/api/vendor/${currentVendorId}/`)
                    .then(response => response.json())
                    .then(vendorData => {
                        document.getElementById('vendor-shop-name').textContent = vendorData.shop_name;
                        document.getElementById('vendor-profile-img').src = vendorData.profile_image_url;
                        document.getElementById('vendor-description').textContent = vendorData.description;
                        document.getElementById('vendor-practices').textContent = vendorData.practices;
                        document.getElementById('vendor-experience').textContent = vendorData.experience;
                        document.getElementById('vendor-permit-number').textContent = vendorData.business_permit_number;
                        document.getElementById('vendor-contact').textContent = vendorData.contact_number;
                        document.getElementById('vendor-email').textContent = vendorData.email;
                        const statusElement = document.getElementById('vendor-verified');
                        if (vendorData.is_verified) {
                            statusElement.textContent = 'Verified';
                            statusElement.className = 'verification-status verified';
                        } else {
                            statusElement.textContent = 'Unverified';
                            statusElement.className = 'verification-status unverified';
                        }
                    });
            });
        }
    });
</script>
{% endblock %}
}