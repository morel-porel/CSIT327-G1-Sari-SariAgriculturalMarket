{% extends 'base.html' %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <link rel="stylesheet" href="{% static 'css/consumer_profile.css' %}">
    <link rel="stylesheet" href="{% static 'css/cart.css' %}">
    <link rel="stylesheet" href="{% static 'css/notifications_dropdown.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Song+Myung&display=swap" rel="stylesheet">
    <style>
        .search-bar { visibility: hidden !important; opacity: 0; }
        body { overflow: hidden; }
    </style>
{% endblock %}

{% block content %}
<header class="navbar">
    <a href="{% url 'home' %}" style="text-decoration: none;">
        <div class="logo">
            <img src="{% static 'icons/sari-sari-logo.png' %}" alt="Logo Icon" class="logo-icon">
            <span style="font-weight: 800;">
                <span class="brand-green">Sari-</span><span class="brand-orange">Sari</span>
            </span>
        </div>
    </a>

    <div class="search-bar">
        <div class="search-container-wrapper">
            <input type="text" id="base-search-input" name="q" placeholder="Search products...">
        </div>
    </div>

    <div class="nav-icons">
        {% if user.role == 'VENDOR' %}
            <div class="cart-nav-container">
                <a href="{% url 'product_list' %}" style="display: flex; align-items: center; text-decoration: none;" title="Manage My Shop">
                    <svg class="cart-icon-svg" viewBox="0 0 24 24">
                        <path d="M20 4H4v2h16V4zm1 10v-2l-1-5H4l-1 5v2h1v6h10v-6h4v6h2v-6h1zm-9 4H6v-4h6v4z"/>
                    </svg>
                </a>
            </div>
        {% else %}
            <div class="cart-nav-container">
                <a href="{% url 'cart' %}" style="display: flex; align-items: center; text-decoration: none;">
                    <svg class="cart-icon-svg" viewBox="0 0 24 24">
                        <path d="M11 9h2V6h3V4h-3V1h-2v3H8v2h3v3zm-4 9c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-8.9-5h7.45c.75 0 1.41-.41 1.75-1.03l3.86-7.01L19.42 4l-3.87 7H8.53L4.27 2H1v2h2l3.6 7.59-1.35 2.44C4.52 15.37 5.48 17 7 17h12v-2H7l1.1-2z"/>
                    </svg>
                    <span class="cart-badge" id="nav-cart-badge" style="display:none;">0</span>
                </a>
                
                <div class="cart-dropdown">
                    <h4>Recently Added Products</h4>
                    <div class="cart-dropdown-list" id="nav-cart-list"></div>
                    <div class="cart-dropdown-footer" id="cart-footer" style="display:none;">
                        <span class="cart-more-text" id="cart-more-text"></span>
                        <a href="{% url 'cart' %}" class="btn-view-cart">View Cart</a>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <div class="notif-nav-container" id="notif-container">
            <a href="{% url 'notification_list' %}" style="display:flex; align-items:center; text-decoration:none;">
                <svg class="notif-icon-svg" viewBox="0 0 24 24">
                    <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/>
                </svg>
                <span class="notif-badge" id="nav-notif-badge" style="display:none;">0</span>
            </a>

            <div class="notif-dropdown">
                <h4>Recent Notifications</h4>
                <div class="notif-dropdown-list" id="nav-notif-list">
                    <div class="empty-notif">Loading...</div>
                </div>
                <div class="notif-dropdown-footer">
                    <a href="{% url 'notification_list' %}" class="view-all-link">View All Notifications</a>
                </div>
            </div>
        </div>

        <a href="{% url 'profile' %}" style="display: flex; align-items: center;">
            {% if user.avatar %}
                <img src="{{ user.avatar.url }}" alt="Profile" class="nav-icon" style="border-radius: 50%; object-fit: cover; width: 28px; height: 28px; border: 1px solid #ddd;">
            {% else %}
                <img src="{% static 'icons/profile.png' %}" alt="Profile Icon" class="nav-icon">
            {% endif %}
        </a>
    </div>
</header>

<main class="container" style="height: calc(100vh - 70px);">
    <aside class="sidebar">
        <h2>Account Menu</h2>
        
        <a href="{% url 'profile' %}" class="sidebar-btn active" style="text-decoration: none;">
            <span>My Account</span>
        </a>

        <a href="{% url 'loyalty_rewards' %}" class="sidebar-btn" style="text-decoration: none;">
            <span>Loyalty Rewards</span>
        </a>

        <a href="{% url 'inbox' %}" class="sidebar-btn" style="text-decoration: none;">
            <span>Messages</span>
        </a>

        <a href="{% url 'notification_list' %}" class="sidebar-btn" style="text-decoration: none;">
            <span>Notifications</span>
        </a>

        <a href="{% url 'about' %}" class="sidebar-btn" style="text-decoration: none;">
            <span>About Us</span>
        </a>
    </aside>

    <div class="main" style="height: 100%; padding: 0;">
        <section class="content" style="height: 100%; overflow-y: auto; background-color: var(--bg-secondary); padding: 30px;">
            
            <form method="post" enctype="multipart/form-data" id="profile-form">
                {% csrf_token %}
                <input type="hidden" name="update_profile" value="update_profile">

                <div class="profile-grid-layout">
                    
                    <div class="grid-column col-1">
                        <div class="modern-card profile-summary-card">
                            <div class="profile-header-bg"></div>
                            <div class="profile-avatar-container">
                                {% if form.instance.avatar %}
                                    <img src="{{ form.instance.avatar.url }}" alt="Profile Avatar" class="avatar-img" id="avatar-preview">
                                {% else %}
                                    <img src="{% static 'icons/profile.png' %}" alt="Profile Avatar" class="avatar-img" id="avatar-preview">
                                {% endif %}
                                
                                <label for="{{ form.avatar.id_for_label }}" class="avatar-edit-overlay">
                                    <span>üì∑</span>
                                </label>
                                <div style="display:none;">{{ form.avatar }}</div>
                            </div>

                            <div class="profile-identity">
                                <h2>{{ user.first_name }} {{ user.last_name }}</h2>
                                <p class="username">@{{ user.username }}</p>
                                <span class="role-badge">{{ user.get_role_display }}</span>
                            </div>

                            <div class="profile-info-list">
                                <div class="info-row">
                                    <span class="label">Email</span>
                                    <span class="value" title="{{ user.email }}">{{ user.email|truncatechars:20 }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">Phone</span>
                                    <span class="value">{{ user.phone_number|default:"--" }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">Location</span>
                                    <span class="value">{{ user.city|default:"--" }}</span>
                                </div>
                                <div class="info-row">
                                    <span class="label">Joined</span>
                                    <span class="value">{{ user.date_joined|date:"M Y" }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="modern-card promo-card">
                            {% if user.role == 'VENDOR' %}
                                <div class="card-body">
                                    <h3>Manage Your Shop</h3>
                                    <p>Check your orders, add products, and view your sales performance.</p>
                                    <a href="{% url 'vendor_profile' %}" class="btn-full-width btn-vendor">
                                        Go to Shop Dashboard
                                    </a>
                                </div>
                            {% else %}
                                <div class="card-body">
                                    <h3>Start Selling Today!</h3>
                                    <p>Join our community of local vendors. Reach more customers and grow your business with Sari-Sari.</p>
                                    <a href="{% url 'become_vendor' %}" class="btn-full-width btn-vendor">
                                        Be A Vendor!
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="grid-column col-2">
                        <div class="modern-card">
                            <div class="card-header">
                                <h3>Personal Information</h3>
                                <button type="button" class="icon-btn edit-toggle" onclick="toggleEdit(this, 'personal-fields')">
                                    <svg class="edit-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                    <svg class="save-icon" viewBox="0 0 24 24" style="display:none;"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                                </button>
                            </div>
                            <div class="card-body form-grid-2">
                                <div class="form-group field-wrapper personal-fields disabled">
                                    <label>First Name</label>
                                    {{ form.first_name }}
                                </div>
                                <div class="form-group field-wrapper personal-fields disabled">
                                    <label>Last Name</label>
                                    {{ form.last_name }}
                                </div>
                                <div class="form-group span-2 field-wrapper personal-fields disabled">
                                    <label>Email Address</label>
                                    {{ form.email }}
                                </div>
                                <div class="form-group field-wrapper personal-fields disabled">
                                    <label>Phone Number</label>
                                    {{ form.phone_number }}
                                </div>
                                <div class="form-group field-wrapper personal-fields disabled">
                                    <label>Date of Birth</label>
                                    {{ form.date_of_birth }}
                                </div>
                            </div>
                        </div>

                        <div class="modern-card">
                            <div class="card-header">
                                <h3>Address Book</h3>
                                <button type="button" class="icon-btn edit-toggle" onclick="toggleEdit(this, 'address-fields')">
                                    <svg class="edit-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                    <svg class="save-icon" viewBox="0 0 24 24" style="display:none;"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                                </button>
                            </div>
                            <div class="card-body form-grid-2">
                                <div class="form-group span-2 field-wrapper address-fields disabled">
                                    <label>Street Address / House No.</label>
                                    {{ form.address }}
                                </div>
                                <div class="form-group field-wrapper address-fields disabled">
                                    <label>City / Municipality</label>
                                    {{ form.city }}
                                </div>
                                <div class="form-group field-wrapper address-fields disabled">
                                    <label>Zip Code</label>
                                    {{ form.zip_code }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-column col-3">
                        <div class="modern-card loyalty-bg">
                            <div class="card-header no-border">
                                <h3 style="color: white;">My Rewards</h3>
                                <a href="{% url 'loyalty_rewards' %}" class="icon-link-white">‚ûî</a>
                            </div>
                            <div class="loyalty-body">
                                <div class="points-circle">
                                    <span class="points-num">{{ user.loyaltyprofile.points|default:"0" }}</span>
                                    <span class="points-label">PTS</span>
                                </div>
                                <div class="rank-display">
                                    Current Rank: <strong>{{ user.loyaltyprofile.rank|default:"Bronze" }}</strong>
                                </div>
                                <div class="loyalty-progress-container">
                                    <div class="loyalty-progress-bar" style="width: 40%;"></div> 
                                </div>
                                <p class="loyalty-next">150 pts to Silver</p>
                            </div>
                        </div>

                        <div class="modern-card">
                            <div class="card-header">
                                <h3>Settings</h3>
                            </div>
                            <div class="settings-list">
                                <button type="button" class="setting-item" onclick="openPasswordModal()">
                                    <span class="icon">üîí</span>
                                    <span class="text">Change Password</span>
                                    <span class="arrow">‚Ä∫</span>
                                </button>
                                
                                <div class="setting-item">
                                    <span class="icon">‚óë</span>
                                    <span class="text">Theme</span>
                                    <select id="theme-switcher" class="mini-select">
                                        <option value="light">Light</option>
                                        <option value="dark">Dark</option>
                                        <option value="contrast">High Contrast</option>
                                    </select>
                                </div>

                                <button type="button" class="setting-item danger">
                                    <span class="icon">üóëÔ∏è</span>
                                    <span class="text">Delete Account</span>
                                </button>
                            </div>
                        </div>

                        <div class="modern-card logout-card">
                            <div class="card-body">
                                <p>Securely end your session.</p>
                                <a href="{% url 'logout' %}" class="btn-full-width btn-logout">
                                    Logout
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </section>
    </div>
</main>

<div id="passwordModal" class="settings-modal">
    <div class="settings-modal-content">
        <span class="settings-close-modal" onclick="closePasswordModal()">&times;</span>
        <h2>Change Password</h2>
        <form method="post">
            {% csrf_token %}
            {% for field in password_form %}
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}<div style="color:red; font-size:0.8rem;">{{ field.errors }}</div>{% endif %}
                </div>
            {% endfor %}
            <button type="submit" name="change_password" value="change_password" class="btn-save-main">Update Password</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const inputs = document.querySelectorAll('.field-wrapper input');
        inputs.forEach(input => input.disabled = true);

        const avatarInput = document.getElementById('{{ form.avatar.id_for_label }}');
        if(avatarInput){
            avatarInput.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('avatar-preview').src = e.target.result;
                    }
                    reader.readAsDataURL(this.files[0]);

                    const allInputs = document.querySelectorAll('#profile-form input, #profile-form select');
                    allInputs.forEach(input => input.disabled = false);

                    document.getElementById('profile-form').submit();
                }
            });
        }
    });

    function toggleEdit(btn, fieldClass) {
        const fields = document.querySelectorAll('.' + fieldClass);
        const inputs = document.querySelectorAll('.' + fieldClass + ' input');
        const editIcon = btn.querySelector('.edit-icon');
        const saveIcon = btn.querySelector('.save-icon');
        const form = document.getElementById('profile-form');

        const isEditing = !inputs[0].disabled;

        if (isEditing) {
            form.submit();
        } else {
            inputs.forEach(input => {
                input.disabled = false;
            });
            fields.forEach(div => div.classList.remove('disabled'));
            
            editIcon.style.display = 'none';
            saveIcon.style.display = 'block';
            
            if(inputs.length > 0) inputs[0].focus();
        }
    }

    function openPasswordModal() { document.getElementById('passwordModal').style.display = 'flex'; }
    function closePasswordModal() { document.getElementById('passwordModal').style.display = 'none'; }
</script>
{% endblock %}