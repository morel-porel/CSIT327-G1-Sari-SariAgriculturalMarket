{% extends 'base.html' %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <link rel="stylesheet" href="{% static 'css/consumer_profile.css' %}">
    <link rel="stylesheet" href="{% static 'css/cart.css' %}">
    <link rel="stylesheet" href="{% static 'css/notifications_dropdown.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Song+Myung&display=swap" rel="stylesheet">
    <style>
        .search-bar {
            visibility: hidden;
        }
        /* Ensure body doesn't scroll */
        body {
            overflow: hidden;
        }
        /* Prevent sidebar from disappearing */
        .sidebar {
            flex-shrink: 0 !important;
            width: 350px !important;
        }
        /* Allow main content to fit in remaining space */
        .main {
            flex-grow: 1 !important;
            min-width: 0 !important; 
            width: auto !important;
        }
    </style>
{% endblock %}

{% block content %}
<header class="navbar">
    <a href="{% url 'home' %}" style="text-decoration: none;">
        <div class="logo">
            <img src="{% static 'icons/sari-sari-logo.png' %}" alt="Logo Icon" class="logo-icon">
            <span style="font-weight: 800;">
                <span class="brand-green">Sari-</span><span class="brand-orange">Sari</span>
            </span>
        </div>
    </a>

    <div class="search-bar">
        <form method="get" action="{% url 'search' %}" autocomplete="off">
            <div class="search-container-wrapper">
                <input type="text" name="q" placeholder="Search products..." style="width: 100%;">
            </div>
            <button type="submit">
                <img src="{% static 'icons/search.png' %}" alt="Search" class="search-icon">
            </button>
        </form>
    </div>

    <div class="nav-icons">
        {% if user.is_authenticated and user.role == 'VENDOR' %}
            <a href="{% url 'product_list' %}">
                <img src="{% static 'icons/cart.png' %}" alt="My Products" class="nav-icon">
            </a>
        {% else %}
            <div class="cart-nav-container">
                <a href="{% url 'cart' %}" style="display: flex; align-items: center; text-decoration: none;">
                    <svg class="cart-icon-svg" viewBox="0 0 24 24">
                        <path d="M11 9h2V6h3V4h-3V1h-2v3H8v2h3v3zm-4 9c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm10 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-8.9-5h7.45c.75 0 1.41-.41 1.75-1.03l3.86-7.01L19.42 4l-3.87 7H8.53L4.27 2H1v2h2l3.6 7.59-1.35 2.44C4.52 15.37 5.48 17 7 17h12v-2H7l1.1-2z"/>
                    </svg>
                    <span class="cart-badge" id="nav-cart-badge" style="display:none;">0</span>
                </a>
                
                <div class="cart-dropdown">
                    <h4>Recently Added Products</h4>
                    <div class="cart-dropdown-list" id="nav-cart-list">
                        </div>
                    <div class="cart-dropdown-footer" id="cart-footer" style="display:none;">
                        <span class="cart-more-text" id="cart-more-text"></span>
                        <a href="{% url 'cart' %}" class="btn-view-cart">View Cart</a>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <div class="notif-nav-container" id="notif-container">
            <a href="{% url 'notification_list' %}" style="display:flex; align-items:center; text-decoration:none;">
                <svg class="notif-icon-svg" viewBox="0 0 24 24">
                    <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/>
                </svg>
                <span class="notif-badge" id="nav-notif-badge" style="display:none;">0</span>
            </a>

            <div class="notif-dropdown">
                <h4>Recent Notifications</h4>
                <div class="notif-dropdown-list" id="nav-notif-list">
                    <div class="empty-notif">Loading...</div>
                </div>
                <div class="notif-dropdown-footer">
                    <a href="{% url 'notification_list' %}" class="view-all-link">View All Notifications</a>
                </div>
            </div>
        </div>

        {% if user.is_authenticated %}
            <a href="{% url 'profile' %}">
                <img src="{% static 'icons/profile.png' %}" alt="Profile" class="nav-icon">
            </a>
        {% else %}
            <a href="{% url 'login' %}">
                <img src="{% static 'icons/profile.png' %}" alt="Profile" class="nav-icon">
            </a>
        {% endif %}
    </div>
</header>

<main class="container" style="height: calc(100vh - 70px);">
    <aside class="sidebar">
        <h2>Account Menu</h2>
        
        <a href="{% url 'profile' %}" class="sidebar-btn active" style="text-decoration: none;">
            <span>My Account</span>
        </a>

        <a href="{% url 'loyalty_rewards' %}" class="sidebar-btn" style="text-decoration: none;">
            <span>Loyalty Rewards</span>
        </a>

        <a href="{% url 'inbox' %}" class="sidebar-btn" style="text-decoration: none;">
            <span>Messages</span>
        </a>

        <a href="{% url 'notification_list' %}" class="sidebar-btn" style="text-decoration: none;">
            <span>Notifications</span>
        </a>

        <a href="{% url 'about' %}" class="sidebar-btn" style="text-decoration: none;">
            <span>About Us</span>
        </a>

        <a href="{% url 'inbox' %}" class="sidebar-btn" style="text-decoration: none;">
            <span>Follow Us</span>
        </a>

        <a href="{% url 'inbox' %}" class="sidebar-btn" style="text-decoration: none;">
            <span>Feedback</span>
        </a>

        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid #eee;">
            {% if user.role == 'VENDOR' %}
                <a href="{% url 'vendor_profile' %}" class="sidebar-btn" style="background-color: #fff3cd; border-color: #ffeeba; color: #856404; text-decoration: none;">
                    <span>Manage Shop</span>
                </a>
            {% else %}
                <a href="{% url 'become_vendor' %}" class="sidebar-btn" style="background-color: #faa625; border-color: #faa625; color: #000; text-decoration: none;">
                    <span>Be a Vendor!</span>
                </a>
            {% endif %}

        
            <a href="{% url 'logout' %}" class="sidebar-btn" style="text-decoration: none; background-color: #c82333; border-color: #bd2130; color: #fff;">
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <div class="main" style="height: 100%; padding: 0;">
        <section class="content" style="height: 100%; overflow: hidden; background-color: var(--bg-secondary); padding: 20px;">
            
            <form method="post" enctype="multipart/form-data" class="profile-form" id="profile-form" style="height: 100%;">
                {% csrf_token %}
                
                <div class="profile-unified-card">
                    
                    <div class="profile-sidebar-panel">
                        
                        <div class="sidebar-header">
                            <div class="profile-avatar-wrapper">
                                {% if form.instance.avatar %}
                                    <img src="{{ form.instance.avatar.url }}" alt="Profile Avatar" class="profile-avatar">
                                {% else %}
                                    <img src="{% static 'icons/profile.png' %}" alt="Profile Avatar" class="profile-avatar">
                                {% endif %}

                                {% if user.role == 'VENDOR' %}
                                    <img src="{% static 'icons/verified.png' %}" class="profile-verified-badge" alt="Verified Vendor" title="Verified Vendor">
                                {% endif %}
                            </div>
                            
                            <h2 class="sidebar-username">{{ user.username }}</h2>
                            <p class="sidebar-role">{{ user.get_role_display }}</p>

                            <label for="{{ form.avatar.id_for_label }}" class="btn-upload" id="photo-upload-btn">Change Photo</label>
                            <div style="display:none;">{{ form.avatar }}</div>
                        </div>

                        <a href="{% url 'loyalty_rewards' %}" class="sidebar-loyalty-box">
                            <div class="loyalty-row">
                                <span class="loyalty-label">Loyalty Points</span>
                                <span class="loyalty-points">{{ user.loyaltyprofile.points|default:"0" }}</span>
                            </div>
                            <div class="loyalty-row">
                                <span class="loyalty-label">Rank</span>
                                <span class="loyalty-rank">{{ user.loyaltyprofile.rank|default:"Bronze" }}</span>
                            </div>
                            <div class="loyalty-arrow">âž”</div>
                        </a>

                        <div class="sidebar-menu">
                            <h3 class="menu-title">Settings</h3>
                            
                            <button type="button" class="menu-item" onclick="openPasswordModal()">
                                <span class="icon">ðŸ”’</span> Change Password
                            </button>

                            <div class="menu-item">
                                <span class="icon">â—‘</span> 
                                <span>Theme</span>
                                <select id="theme-switcher" class="mini-select">
                                    <option value="light">Light</option>
                                    <option value="dark">Dark</option>
                                    <option value="contrast">High Contrast</option>
                                </select>
                            </div>

                            <button type="button" class="menu-item text-danger btn-delete-account">
                                <span class="icon">âœ–</span> Delete Account
                            </button>
                        </div>
                    </div>

                    <div class="profile-content-panel">
                        
                        <div class="panel-section">
                            <h2 class="panel-title">Personal Details</h2>
                            <div class="profile-grid">
                                <div class="form-group">
                                    <label>First Name</label>
                                    {{ form.first_name }}
                                </div>
                                <div class="form-group">
                                    <label>Last Name</label>
                                    {{ form.last_name }}
                                </div>
                                <div class="form-group span-2">
                                    <label>Email Address</label>
                                    {{ form.email }}
                                </div>
                                <div class="form-group">
                                    <label>Phone Number</label>
                                    {{ form.phone_number }}
                                </div>
                                <div class="form-group">
                                    <label>Date of Birth</label>
                                    {{ form.date_of_birth }}
                                </div>
                            </div>
                        </div>

                        <div class="panel-section">
                            <h2 class="panel-title">Address Book</h2>
                            <div class="profile-grid">
                                <div class="form-group span-2">
                                    <label>Street Address</label>
                                    {{ form.address }}
                                </div>
                                <div class="form-group">
                                    <label>City</label>
                                    {{ form.city }}
                                </div>
                                <div class="form-group">
                                    <label>Zip Code</label>
                                    {{ form.zip_code }}
                                </div>
                            </div>
                        </div>

                        <div class="panel-footer">
                            <p class="member-since">Member Since: {{ user.date_joined|date:'F d, Y' }}</p>
                            <button type="button" class="btn-save-main" id="save-all-btn">Save Changes</button>
                            <input type="hidden" name="update_profile" value="update_profile">
                        </div>

                    </div>
                </div>
            </form>
        </section>
    </div>
</main>

<div id="passwordModal" class="settings-modal">
    <div class="settings-modal-content">
        <span class="settings-close-modal" onclick="closePasswordModal()">&times;</span>
        <h2>Change Password</h2>
        <form method="post">
            {% csrf_token %}
            {% for field in password_form %}
                <div class="form-group" style="margin-bottom: 15px;">
                    <label>{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}<div style="color:red; font-size:0.8rem;">{{ field.errors }}</div>{% endif %}
                </div>
            {% endfor %}
            <button type="submit" name="change_password" value="change_password" class="btn-save-main">Update</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const saveBtn = document.getElementById('save-all-btn');
        const form = document.getElementById('profile-form');
        const photoBtn = document.getElementById('photo-upload-btn');
        
        const inputs = form.querySelectorAll('input:not([type="hidden"]), select');
        let isEditing = false;

        inputs.forEach(input => {
            if (!input.classList.contains('readonly-field')) {
                input.disabled = true;
            }
        });
        photoBtn.style.display = 'none';
        saveBtn.textContent = 'Edit Profile';

        saveBtn.addEventListener('click', function(e) {
            if (!isEditing) {
                e.preventDefault();
                inputs.forEach(input => {
                    if (!input.classList.contains('readonly-field')) {
                        input.disabled = false;
                    }
                });
                photoBtn.style.display = 'inline-block';
                saveBtn.textContent = 'Save Changes';
                saveBtn.classList.add('active-edit');
                isEditing = true;
            } else {
                form.submit();
            }
        });
    });

    function openPasswordModal() { document.getElementById('passwordModal').style.display = 'flex'; }
    function closePasswordModal() { document.getElementById('passwordModal').style.display = 'none'; }
</script>
{% endblock %}